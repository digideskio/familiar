/*
jQuery UI Virtual Keyboard Widget
Version 1.6 minified

Author: Jeremy Satterfield
Modified: Rob G (Mottie on github)
-----------------------------------------
Creative Commons Attribution-Share Alike 3.0 Unported License
http://creativecommons.org/licenses/by-sa/3.0/

Caret code from jquery.caret.1.02.js
Licensed under the MIT License:
http://www.opensource.org/licenses/mit-license.php
-----------------------------------------
*/

(function(g){g.keyboard=function(k,l){var a=this;a.$el=g(k);a.el=k;a.$el.data("keyboard",a);a.init=function(){a.options=g.extend(true,{},g.keyboard.defaultOptions,l);a.shiftActive=false;a.altActive=false;a.metaActive=false;a.sets=false;a.rows=["ui-keyboard-keyset-default","ui-keyboard-keyset-shift","ui-keyboard-keyset-alt","ui-keyboard-keyset-alt-shift"];a.acceptedKeys=[];a.docSel=document.selection;g.each("visible hidden canceled accepted".split(" "),function(b,f){g.isFunction(a.options[f])&&a.$el.bind(f, a.options[f])});g(document).bind("mousedown keyup",function(b){if(b.type==="keyup"&&b.which===27||b.type!=="keyup")a.escClose(b)});a.$el.addClass("ui-keyboard-input ui-widget-content ui-corner-all").attr({"aria-haspopup":"true",role:"textbox"}).bind("focus",function(){typeof a.$keyboard==="undefined"&&a.startup();a.$preview.val(a.$el.val());a.$keyboard.css({position:"absolute",left:0,top:0}).show().position({of:a.options.position.of||a.$el.data("keyboardPosition")||a.$el,my:a.options.position.my, at:a.options.position.at,collision:"fit"});a.$preview.css("width",a.docSel?a.$keyboard.width():"100%").focus();a.checkDecimal();if(a.docSel){var b=a.$preview.val().length;a.$preview.caret(b,b);g('<div class="ui-keyboard-overlay"></div>').click(function(){g(this).remove();a.kbHide()}).appendTo("body")}a.$el.trigger("visible",a.$el)})};a.startup=function(){a.$keyboard=a.buildKeyboard();a.$allKeys=a.$keyboard.find(".ui-keyboard-button");a.$preview=a.$keyboard.find(".ui-keyboard-preview");a.preview=a.$preview[0]; a.$decBtn=a.$keyboard.find(".ui-keyboard-dec");a.wheel=g.isFunction(g.fn.mousewheel);a.$preview.bind("keyup",function(b){b.which===9&&a.keyaction.tab()}).bind("keydown",function(b){if(b.which===9)return false;if(b.which===13&&(b.target.tagName==="INPUT"||b.shiftKey)){a.acceptClose();return false}});a.$keyboard.appendTo("body");a.$allKeys.bind(a.options.keyBinding,function(){var b;b=g.data(this,"key");var f=b.action;if(f.match("meta"))f="meta";if(a.keyaction.hasOwnProperty(f))a.keyaction[f](this); else if(typeof b.action!=="undefined"){b=a.wheel&&!g(this).is(".ui-keyboard-actionkey")?b.curTxt:b.action;a.insertText(b)}a.$preview.focus()}).bind("mouseenter mouseleave mousewheel",function(b,f){var d=g(this),c,e=g.data(this,"key");if(b.type==="mouseenter")d.addClass("ui-state-hover").attr("title",function(i,h){return a.wheel&&h===""&&a.sets?a.options.wheelMessage:h});else if(b.type==="mouseleave"){e.curTxt=e.original;e.curNum=0;g.data(this,"key",e);d.removeClass("ui-state-hover").attr("title", function(i,h){return h===a.options.wheelMessage?"":h}).val(e.original)}else if(a.wheel){c=e.layers||a.getLayers(d);e.curNum+=f>0?-1:1;if(e.curNum>c.length-1)e.curNum=0;if(e.curNum<0)e.curNum=c.length-1;e.layers=c;e.curTxt=c[e.curNum];g.data(this,"key",e);d.val(c[e.curNum])}}).bind("mouseup",function(){a.$preview.focus()});a.$decBtn.length&&a.$allKeys.click(function(){a.checkDecimal()})};a.insertText=function(b){var f,d,c=a.$preview.caret().start,e=a.$preview.val(),i=e.length;if(a.docSel){d=c;f=d- 1;if(c<i)for(;f--;)if(e.substring(f-1,f)==="\n")c-=1;if(e.slice(-1)==="\n"&&d===i-1)c+=1}if(b==="bksp"){d=[e.substring(0,c-1)+e.substring(c,i)];c-=1}else{e=e.substring(0,c)+b+e.substring(c,i);d=a.checkCombos(e);c+=d[1]+b.length}a.$preview.val(d[0]).caret(c,c);a.preview.scrollTop=c>i/2?a.preview.scrollHeight:0};a.showKeySet=function(b){a.$keyboard.find(".ui-keyboard-actionkey[name*=key_meta]").removeClass("ui-state-active");if(a.metaActive){b=b.name.split("_")[1];a.$keyboard.find(".ui-keyboard-alt, .ui-keyboard-shift, .ui-keyboard-actionkey[class*=meta]").removeClass("ui-state-active").end().find(".ui-keyboard-actionkey.ui-keyboard-"+ b).addClass("ui-state-active").end().find(".ui-keyboard-keyset").hide().end().find(".ui-keyboard-keyset-"+b).show()}else{b=a.shiftActive?1:0;b+=a.altActive?2:0;a.$keyboard.find(".ui-keyboard-alt")[a.altActive?"addClass":"removeClass"]("ui-state-active").end().find(".ui-keyboard-shift")[a.shiftActive?"addClass":"removeClass"]("ui-state-active").end().find(".ui-keyboard-keyset").hide().end().find("."+a.rows[b]).show()}};a.checkCombos=function(b){var f,d=b.length,c;if(a.options.useCombos)b=b.replace(/([`\'~\^\"ao])([a-z])/ig, function(e,i,h){return i in a.options.combos?a.options.combos[i][h]||e:e});if(a.options.restrictInput){c=b.split("");for(f=0;f<d;f++)if(g.inArray(c[f],a.acceptedKeys)<0)b=b.replace(c[f],"")}if(a.options.maxLength!==false&&b.length>a.options.maxLength)b=b.substring(0,a.options.maxLength);return[b,b.length-d]};a.checkDecimal=function(){/\./.test(a.$decBtn.closest(".ui-keyboard").find(".ui-keyboard-preview").val())?a.$decBtn.attr({disabled:"disabled","aria-disabled":"true"}).removeClass("ui-state-default ui-state-hover").addClass("ui-state-disabled"): a.$decBtn.removeAttr("disabled").attr({"aria-disabled":"false"}).addClass("ui-state-default").removeClass("ui-state-disabled")};a.getLayers=function(b){var f;f=b.attr("name");return b.closest(".ui-keyboard").find("input[name="+f+"]").map(function(){return this.value}).get()};a.kbHide=function(b){if(typeof a.$keyboard!=="undefined")if(a.$keyboard.is(":visible")){a.$el.scrollTop(a.el.scrollHeight);a.$keyboard.hide();a.$el.trigger(b?"accepted":"canceled",a.$el);a.$el.trigger("hidden",a.$el)}};a.acceptClose= function(){a.el.value=a.preview.value;a.kbHide(true)};a.escClose=function(b){g(b.target).closest(".ui-keyboard").length||a.kbHide()};a.keyBtn=g("<input />").attr({type:"button",role:"button","aria-disabled":"false"}).addClass("ui-keyboard-button ui-state-default ui-corner-all");a.addKey=function(b,f,d){var c,e;f=d===true?b:a.options.display[f]||b;c=f.split(":");f=c[0]!==""&&c.length>1?g.trim(c[0]):f;c=c.length>1?g.trim(c[1]).replace(/_/g," ")||"":"";e=f.length>1?" ui-keyboard-widekey":"";e+=d!==true? " ui-keyboard-actionkey":"";return a.keyBtn.clone().attr({name:"key_"+b,title:c}).data("key",{action:b,original:f,curTxt:f,curNum:0}).val(f).addClass("ui-keyboard-"+(d===true?b.charCodeAt(0):b)+e)};a.buildKeyboard=function(){var b,f,d,c,e,i,h,j,o,m=0,n=g("<div />").addClass("ui-keyboard ui-widget-content ui-widget ui-corner-all ui-helper-clearfix").attr({role:"textbox"}).hide();a.$preview=a.$el.clone(false).removeAttr("id").show().attr(a.options.lockInput?{readonly:"readonly"}:{}).addClass("ui-widget-content ui-keyboard-preview ui-corner-all").bind("keyup", function(){var p=a.$preview.caret().start,q=a.checkCombos(a.$preview.val());if(q[1]!==0){p+=q[1];a.$preview.val(q[0]).caret(p,p)}});g("<div />").append(a.$preview).appendTo(n);if(a.options.layout==="custom")g.keyboard.layouts.custom=a.options.customLayout||{"default":["{cancel}"]};for(c in g.keyboard.layouts[a.options.layout]){j=g.keyboard.layouts[a.options.layout][c];m++;e=g("<div />").addClass("ui-keyboard-keyset ui-keyboard-keyset-"+c).appendTo(n)[c==="default"?"show":"hide"]();for(f in j){d=g("<div />").addClass("ui-keyboard-row ui-keyboard-row"+ f).appendTo(e);b=g.trim(j[f]).replace(/\{(\.?)[\s+]?:[\s+]?(\.?)\}/g,"{$1:$2}");h=b.split(/\s+/);for(i in h)if(h[i].length!==0)if(/^\{\S+\}$/.test(h[i])){b=h[i].match(/^\{(\S+)\}$/)[1].toLowerCase();if(/^sp:(\.?\d+)$/.test(b)){o=b.match(/^sp:(\.?\d+)$/)[1]||0;g("<span>&nbsp;</span>").css("margin","0 "+o+"em").appendTo(d)}if(/^meta\d+\:?(\w+)?/.test(b))a.addKey(b,b).appendTo(d);else switch(b){case "a":case "accept":a.addKey("accept",b).addClass(a.options.actionClass).appendTo(d);break;case "alt":case "altgr":a.addKey("alt", "alt").appendTo(d);break;case "b":case "bksp":a.addKey("bksp",b).appendTo(d);break;case "c":case "cancel":a.addKey("cancel",b).addClass(a.options.actionClass).appendTo(d);break;case "clear":a.addKey("clear","clear").appendTo(d);break;case "dec":a.acceptedKeys.push(".");a.addKey("dec","dec").appendTo(d);break;case "e":case "enter":a.addKey("enter",b).appendTo(d);break;case "s":case "shift":a.addKey("shift",b).appendTo(d);break;case "sign":a.acceptedKeys.push("-");a.addKey("sign","sign").appendTo(d); break;case "space":a.acceptedKeys.push(" ");a.addKey("space","space").appendTo(d);break;case "t":case "tab":a.addKey("tab",b).appendTo(d)}}else{a.acceptedKeys.push(h[i]);a.addKey(h[i],h[i],true).attr("name","key_"+f+"_"+i).appendTo(d)}}}if(m>1)a.sets=true;return n};a.destroy=function(){a.$keyboard.remove();a.$el.removeClass("ui-keyboard-input ui-widget-content ui-corner-all").removeAttr("aria-haspopup").removeAttr("role").unbind("focus accepted canceled hidden visible");g(document).unbind("mousedown keyup", a.escClose)};a.keyaction={accept:function(){a.acceptClose()},alt:function(b){a.altActive=!a.altActive;a.metaActive=false;a.showKeySet(b)},cancel:function(){a.kbHide()},clear:function(){a.$preview.val("")},dec:function(){a.insertText(".")},enter:function(){a.insertText("\r\n")},meta:function(b){a.metaActive=g(b).is(".ui-state-active")?false:true;a.showKeySet(b)},shift:function(b){a.shiftActive=!a.shiftActive;a.metaActive=false;a.showKeySet(b)},sign:function(){/^\-?\d*\.?\d*$/.test(a.$preview.val())&& a.$preview.val(a.$preview.val()*-1)},space:function(){a.insertText(" ")},tab:function(){a.insertText("\t")}};a.init()};g.keyboard.layouts={alpha:{"default":["` 1 2 3 4 5 6 7 8 9 0 - = {bksp}","{tab} a b c d e f g h i j [ ] \\","k l m n o p q r s ; ' {enter}","{shift} t u v w x y z , . / {shift}","{accept} {space} {cancel}"],shift:["~ ! @ # $ % ^ & * ( ) _ + {bksp}","{tab} A B C D E F G H I J { } |",'K L M N O P Q R S : " {enter}',"{shift} T U V W X Y Z < > ? {shift}","{accept} {space} {cancel}"]}, qwerty:{"default":["` 1 2 3 4 5 6 7 8 9 0 - = {bksp}","{tab} q w e r t y u i o p [ ] \\","a s d f g h j k l ; ' {enter}","{shift} z x c v b n m , . / {shift}","{accept} {space} {cancel}"],shift:["~ ! @ # $ % ^ & * ( ) _ + {bksp}","{tab} Q W E R T Y U I O P { } |",'A S D F G H J K L : " {enter}',"{shift} Z X C V B N M < > ? {shift}","{accept} {space} {cancel}"]},international:{"default":["` 1 2 3 4 5 6 7 8 9 0 - = {bksp}","{tab} q w e r t y u i o p [ ] \\","a s d f g h j k l ; ' {enter}","{shift} z x c v b n m , . / {shift}", "{accept} {space} {alt} {cancel}"],shift:["~ ! @ # $ % ^ & * ( ) _ + {bksp}","{tab} Q W E R T Y U I O P { } |",'A S D F G H J K L : " {enter}',"{shift} Z X C V B N M < > ? {shift}","{accept} {space} {alt} {cancel}"],alt:["~ \u00a1 \u00b2 \u00b3 \u00a4 \u20ac \u00bc \u00bd \u00be \u2018 \u2019 \u00a5 \u00d7 {bksp}","{tab} \u00e4 \u00e5 \u00e9 \u00ae \u00fe \u00fc \u00fa \u00ed \u00f3 \u00f6 \u00ab \u00bb \u00ac","\u00e1 \u00df \u00f0 f g h j k \u00f8 \u00b6 \u00b4 {enter}","{shift} \u00e6 x \u00a9 v b \u00f1 \u00b5 \u00e7 > \u00bf {shift}", "{accept} {space} {alt} {cancel}"],"alt-shift":["~ \u00b9 \u00b2 \u00b3 \u00a3 \u20ac \u00bc \u00bd \u00be \u2018 \u2019 \u00a5 \u00f7 {bksp}","{tab} \u00c4 \u00c5 \u00c9 \u00ae \u00de \u00dc \u00da \u00cd \u00d3 \u00d6 \u00ab \u00bb \u00a6","\u00c4 \u00a7 \u00d0 F G H J K \u00d8 \u00b0 \u00a8 {enter}","{shift} \u00c6 X \u00a2 V B \u00d1 \u00b5 \u00c7 . \u00bf {shift}","{accept} {space} {alt} {cancel}"]},dvorak:{"default":["` 1 2 3 4 5 6 7 8 9 0 [ ] {bksp}","{tab} ' , . p y f g c r l / = \\","a o e u i d h t n s - {enter}", "{shift} ; q j k x b m w v z {shift}","{accept} {space} {cancel}"],shift:["~ ! @ # $ % ^ & * ( ) { } {bksp}",'{tab} " < > P Y F G C R L ? + |',"A O E U I D H T N S _ {enter}","{shift} : Q J K X B M W V Z {shift}","{accept} {space} {cancel}"]},num:{"default":["= ( ) {b}","{clear} / * -","7 8 9 +","4 5 6 {sign}","1 2 3 %","0 . {a} {c}"]}};g.keyboard.defaultOptions={layout:"qwerty",customLayout:null,position:{of:null,my:"center top",at:"center top"},display:{a:"\u2714:Accept (Shift-Enter)",accept:"Accept:Accept (Shift-Enter)", alt:"AltGr:Alternate Graphemes",b:"\u2190:Backspace",bksp:"Bksp:Backspace",c:"\u2716:Cancel (Esc)",cancel:"Cancel:Cancel (Esc)",clear:"C:Clear",dec:".:Decimal",e:"\u21b5:Enter",enter:"Enter:Enter",s:"\u21e7:Shift",shift:"Shift:Shift",sign:"\u00b1:Change Sign",space:"Space:Space",t:"\u21e5:Tab",tab:"\u21e5 Tab:Tab"},wheelMessage:"Use mousewheel to see other keys",actionClass:"ui-state-active",lockInput:false,restrictInput:false,maxLength:false,keyBinding:"mousedown",useCombos:true,combos:{"`":{a:"\u00e0", A:"\u00c0",e:"\u00e8",E:"\u00c8",i:"\u00ec",I:"\u00cc",o:"\u00f2",O:"\u00d2",u:"\u00f9",U:"\u00d9"},"'":{a:"\u00e1",A:"\u00c1",e:"\u00e9",E:"\u00c9",i:"\u00ed",I:"\u00cd",o:"\u00f3",O:"\u00d3",u:"\u00fa",U:"\u00da",y:"\u00fd",Y:"\u00dd",c:"\u00e7",C:"\u00c7"},'"':{a:"\u00e4",A:"\u00c4",e:"\u00eb",E:"\u00cb",i:"\u00ef",I:"\u00cf",o:"\u00f6",O:"\u00d6",u:"\u00fc",U:"\u00dc"},"^":{a:"\u00e2",A:"\u00c2",e:"\u00ea",E:"\u00ca",i:"\u00ee",I:"\u00ce",o:"\u00f4",O:"\u00d4",u:"\u00fb",U:"\u00db"},"~":{a:"\u00e3", A:"\u00c3",e:"\u1ebd",E:"\u1ebc",i:"\u0129",I:"\u0128",o:"\u00f5",O:"\u00d5",u:"\u0169",U:"\u0168",n:"\u00f1",N:"\u00d1"},a:{e:"\u00e6"},A:{E:"\u00c6"},o:{e:"\u0153"},O:{E:"\u0152"}},accepted:null,canceled:null,hidden:null,visible:null};g.fn.keyboard=function(k){return this.each(function(){new g.keyboard(this,k)})};g.fn.getkeyboard=function(){this.data("keyboard")}})(jQuery); (function(g,k,l,a){g.fn.caret=function(b,f){var d,c,e,i,h;h=document.selection;var j=this[0],o=j.scrollTop,m=g.browser.msie;if(typeof b==="number"&&typeof f==="number"){c=b;i=f}if(typeof c!=="undefined"){if(m){h=j.createTextRange();h.collapse(true);h.moveStart("character",c);h.moveEnd("character",i-c);h.select()}else{j.selectionStart=c;j.selectionEnd=i}j.focus();j.scrollTop=o;return this}else{if(m)if(j.tagName.toLowerCase()!=="textarea"){i=this.val();c=h[l]()[a]();c.moveEnd("character",i[k]);d=c.text=== ""?i[k]:i.lastIndexOf(c.text);c=h[l]()[a]();c.moveStart("character",-i[k]);e=c.text[k]}else{c=h[l]();h=c[a]();h.moveToElementText(j);h.setEndPoint("EndToEnd",c);d=h.text[k]-c.text[k];e=d+c.text[k]}else{d=j.selectionStart;e=j.selectionEnd}h=j.value.substring(d,e);return{start:d,end:e,text:h,replace:function(n){return j.value.substring(0,d)+n+j.value.substring(e,j.value[k])}}}}})(jQuery,"length","createRange","duplicate");
